# 流體系統（Fluids）

!!! abstract "想建立會消耗或產生流體的方塊嗎？"
    請參考「Fluid blocks」教學。這是一份關於流體運作的技術說明。

## 流體點（Fluid points）

流體點是你在放置管線時需要點擊的紅／綠／灰色立方體之一。共有三種類型的流體點：`INPUT`（綠色）、`OUTPUT`（紅色）與 `CONNECTOR`（灰色）。輸入與輸出點附加在方塊上，用於加入或移除流體；而連接點則僅用於將不同流體點相互連接。

若要為你的機器建立流體連接點，可以呼叫 `FluidPointInteraction.make(...)`。

## 流體方塊（Fluid blocks）

### PylonFluidBlock

任何具有流體輸入／輸出的方塊都必須實作 `PylonFluidBlock`。此介面允許你從輸入點請求流體、向輸出點提供流體，並定義如何在方塊中加入／移除流體。如有疑問，請參考「ticking」章節了解詳細運作方式。

更多使用說明可參閱 `PylonFluidBlock` 的 Javadoc 文件。

### PylonFluidBufferBlock

通常流體機器會在內部儲存流體。例如，壓榨機（press）擁有一個內部緩衝槽（buffer）用於儲存植物油，預設容量為 1000mB。這是非常常見的情況，因此我們建立了 `PylonFluidBufferBlock` 介面來處理。此介面可讓方塊輕鬆管理流體緩衝。

更多使用說明可參閱 `PylonFluidBufferBlock` 的 Javadoc 文件。

### PylonFluidTank

另一種常見模式是「流體槽（fluid tank）」：它一次只能儲存一種流體，但可以儲存多種類型的流體。`PylonFluidTank` 實作了此設計模式。

更多使用說明可參閱 `PylonFluidTank` 的 Javadoc 文件。

## 實體與虛擬流體點（Physical vs virtual fluid points）

流體點分為「實體」與「虛擬」兩種。「實體流體點」是顯示在遊戲中的紅／綠／灰色方塊框，用於顯示與互動；其內部包含一個「虛擬流體點」。這樣的區分雖然看似複雜，但能讓底層邏輯更為簡潔。

實體流體點主要作為虛擬流體點的外層包裝，負責顯示與玩家互動；你幾乎不需要關心它。因此當我們提到「流體點」時，指的通常是虛擬流體點。

虛擬流體點具有以下屬性：UUID（唯一識別）、流體點類型、已連接的流體點以及所屬方塊。若該流體點是輸入或輸出類型，則其方塊必須實作 `PylonFluidBlock`。

## 區段（Segments）

流體的運作依賴「區段（segment）」的概念。區段是一組相互連接的流體點集合，封裝了**所有連通的流體點**。例如（以虛線代表管線）：
```
A---B-----C  D--E    F
```
此時 A、B、C 屬於同一區段；D、E 屬於另一區段；F 為第三區段。  
若移除 B 與 C 之間的管線，A、B 將形成新區段，而 C 也會成為新的區段。相反地，若將 C 與 D 連接，則原本的 A/B/C 與 D/E 區段會合併為一個新區段。

## 流體更新（Ticking）

區段是流體系統運作的基礎。每個區段會依伺服器設定，每隔數個遊戲刻（tick）更新一次。當一個區段被更新時，會執行以下步驟：

1. 針對區段內的每個方塊呼叫 `getRequestedFluids`，建立所有被請求流體及其數量的清單。
2. 遍歷每一種被供應的流體。
3. 若該流體不被區段允許，則跳過。
4. 若沒有任何機器請求該流體（即 `fluidAmountRequested` 為零），則跳過。
5. 找到至少有一台機器請求該流體時，使用輪詢（round-robin）演算法根據可通過管線的流體量與請求量，盡可能從供應方取出流體。
6. 再次使用輪詢演算法，平均分配流體至接收方機器。

## 流速與允許流體（Fluid flow rates and allowed fluids）

為了限制流體在管線中傳輸的速度，我們將流速限制設定在**區段層級**而非每條管線。這樣能在降低運算成本的同時達到效果。  
同樣地，也可以限制允許通過的流體種類（例如木製管線禁止高溫流體），這同樣以區段為單位設定。

這也是不同管線無法互相連接的原因之一：若兩者相連，應該採用哪個流速限制？

當區段合併時，系統會隨機選擇其中一個區段並保留其流速與允許流體設定；當區段被分割時，新區段會繼承舊區段的設定。

## 管線放置邏輯（Pipe placement logic）

這部分的邏輯極其複雜。如果你真的需要修改這段程式碼——祝你好運。
